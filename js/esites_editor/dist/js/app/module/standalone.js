define(["codemirror/lib/codemirror","gator","./code","./util","../var/plugin"],function(CodeMirror,Gator,code,util,plugin){"use strict";function _monitorChanges(){var textarea=this.getTextArea();if(""!==textarea.value){this.setValue(code.format("html",textarea.value));if(stylesEditor){cssCode=stylesEditor.value;plugin.settings.autoFormat&&(cssCode=code.format("css",stylesEditor.value));cmStyles.setValue(cssCode)}clearInterval(timer)}}function _createCssEditor(editor){if(stylesEditor){cmStyles=CodeMirror.fromTextArea(stylesEditor,util.extend(editor.options,{mode:"css"}));cmStyles.on("blur",editor.syncValue);plugin.settings.emmet&&editor.initEmmet(cmStyles)}}function _emptyTextAreas(editor){stylesEditor&&(stylesEditor.value="");util.forEach(editor.instances,function(el){el.getTextArea().value=""})}function _init(cm,editor){var cursor,cm=cm;cm.on("blur",editor.syncValue);_createCssEditor(editor);"undefined"!=typeof Ajax&&Ajax.Responders.register({onComplete:function(){var url,args=arguments;if(args.length>1){url=args[1].request.url;(url.indexOf("onInsert")>-1||url.indexOf("buildWidget")>-1)&&editor.insertSnippet(args[1].responseText,cm,cursor)}}});Gator(document).on("click","#variables-chooser_content a",function(){editor.insertVariable(this,cm)}).on("mousedown",".magento_close",function(){clearInterval(timer)}).on("click","#email_template_load_form button",function(){_emptyTextAreas(editor);timer=setInterval(util.proxy(_monitorChanges,cm),250)}).on("click",".add-image, .add-widget",function(){cursor=cm.getCursor()})}var cmStyles,cssCode,timer=null,stylesEditor=util.getElem("template_styles");return{init:_init}});